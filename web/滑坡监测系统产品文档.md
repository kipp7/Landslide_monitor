# 滑坡监测系统 v1.0
## 产品技术文档

---

### 文档信息
- **产品名称**: 滑坡监测系统 (Landslide Monitoring System)
- **版本**: v1.0.0
- **发布日期**: 2025年7月17日
- **文档类型**: 产品技术文档
- **适用对象**: 技术人员、运维人员、项目管理者

---

## 目录

1. [产品概述](#1-产品概述)
2. [系统架构](#2-系统架构)
3. [技术规格](#3-技术规格)
4. [部署指南](#4-部署指南)
5. [配置管理](#5-配置管理)
6. [API文档](#6-api文档)
7. [运维管理](#7-运维管理)
8. [故障排除](#8-故障排除)
9. [安全规范](#9-安全规范)
10. [附录](#10-附录)

---

## 1. 产品概述

### 1.1 产品简介

滑坡监测系统是一套基于物联网技术的实时地质灾害监测解决方案，通过部署在滑坡易发区域的RK2206传感器设备，实时采集温度、湿度、加速度、陀螺仪等多维度环境数据，经华为云IoT平台传输至数据处理中心，为地质灾害预警提供科学依据。

### 1.2 核心特性

| 特性 | 描述 | 技术实现 |
|------|------|----------|
| **实时数据采集** | 24/7不间断监测 | RK2206 + 华为云IoT |
| **多传感器融合** | 温湿度、三轴加速度、陀螺仪 | 多传感器数据融合算法 |
| **云端数据处理** | 自动数据解析和存储 | Node.js + Supabase |
| **可视化展示** | 实时数据图表和趋势分析 | Next.js + Chart.js |
| **异常告警** | 智能阈值监测和预警 | 规则引擎 + 通知系统 |
| **高可用性** | 99.9%系统可用性保证 | 负载均衡 + 自动恢复 |

### 1.3 应用场景

- **地质灾害监测**: 滑坡、泥石流、山体崩塌预警
- **基础设施监控**: 边坡、挡土墙、桥梁结构健康监测
- **环境监测**: 山区气象、土壤湿度、降雨量监测
- **科研应用**: 地质研究、环境科学数据采集

### 1.4 技术优势

- **低功耗设计**: RK2206芯片，电池续航6个月以上
- **高精度传感**: 温度精度±0.1℃，加速度精度0.001g
- **实时传输**: 数据延迟<5秒，支持4G/WiFi双模
- **云端处理**: 弹性扩容，支持万级设备并发
- **开放架构**: 标准API接口，易于集成和扩展

---

## 2. 系统架构

### 2.1 整体架构图

```
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐    ┌──────────────────┐
│   RK2206设备    │    │   华为云IoT平台   │    │   数据处理中心   │    │    用户界面      │
│                 │    │                  │    │                 │    │                  │
│ ┌─────────────┐ │    │ ┌──────────────┐ │    │ ┌─────────────┐ │    │ ┌──────────────┐ │
│ │ 传感器模块  │ │    │ │ 设备管理     │ │    │ │ IoT服务     │ │    │ │ Web控制台    │ │
│ │ - 温湿度    │ │    │ │ 数据转发     │ │    │ │ 数据解析    │ │    │ │ 实时监控     │ │
│ │ - 加速度    │ │◄──►│ │ 规则引擎     │ │◄──►│ │ 异常检测    │ │◄──►│ │ 历史查询     │ │
│ │ - 陀螺仪    │ │    │ │ 安全认证     │ │    │ │ 数据存储    │ │    │ │ 告警管理     │ │
│ └─────────────┘ │    │ └──────────────┘ │    │ └─────────────┘ │    │ └──────────────┘ │
│                 │    │                  │    │                 │    │                  │
└─────────────────┘    └──────────────────┘    └─────────────────┘    └──────────────────┘
      设备层                 云平台层               应用层                 展示层
```

### 2.2 数据流架构

```
RK2206传感器 → 4G/WiFi → 华为云IoT → HTTP推送 → nginx反向代理 → Node.js服务 → Supabase数据库 → Next.js前端
     ↓              ↓           ↓            ↓              ↓             ↓              ↓
  传感器数据      无线传输    云端接收      数据转发        服务处理       数据存储        用户展示
```

### 2.3 技术栈

| 层级 | 技术组件 | 版本要求 | 作用 |
|------|----------|----------|------|
| **设备层** | RK2206芯片 | - | 数据采集和传输 |
| **传输层** | 4G/WiFi | - | 网络通信 |
| **云平台层** | 华为云IoT | - | 设备管理和数据转发 |
| **网关层** | nginx | 1.18+ | 反向代理和负载均衡 |
| **应用层** | Node.js | 18+ | 后端服务和数据处理 |
| **数据层** | Supabase | - | 数据存储和管理 |
| **展示层** | Next.js | 14+ | 前端界面和可视化 |

---

## 3. 技术规格

### 3.1 硬件规格

#### RK2206传感器设备
| 参数 | 规格 | 说明 |
|------|------|------|
| **主控芯片** | RK2206 | ARM Cortex-M4内核 |
| **工作电压** | 3.3V | 低功耗设计 |
| **工作温度** | -40℃ ~ +85℃ | 工业级温度范围 |
| **防护等级** | IP67 | 防水防尘 |
| **通信方式** | 4G/WiFi | 双模通信 |
| **电池续航** | 6个月+ | 3000mAh锂电池 |

#### 传感器模块
| 传感器 | 型号 | 精度 | 量程 |
|--------|------|------|------|
| **温度传感器** | SHT30 | ±0.1℃ | -40℃ ~ +125℃ |
| **湿度传感器** | SHT30 | ±1.5%RH | 0 ~ 100%RH |
| **三轴加速度** | MPU6050 | 0.001g | ±16g |
| **三轴陀螺仪** | MPU6050 | 0.01°/s | ±2000°/s |
| **气压传感器** | BMP280 | ±0.12hPa | 300 ~ 1100hPa |

### 3.2 软件规格

#### 系统要求
| 组件 | 最低要求 | 推荐配置 |
|------|----------|----------|
| **操作系统** | Ubuntu 18.04+ | Ubuntu 22.04 LTS |
| **CPU** | 2核心 | 4核心+ |
| **内存** | 4GB | 8GB+ |
| **存储** | 20GB | 100GB+ SSD |
| **网络** | 10Mbps | 100Mbps+ |

#### 软件依赖
| 软件 | 版本 | 用途 |
|------|------|------|
| **Node.js** | 18.0+ | 运行时环境 |
| **nginx** | 1.18+ | 反向代理 |
| **npm** | 9.0+ | 包管理器 |

### 3.3 性能指标

| 指标 | 目标值 | 说明 |
|------|--------|------|
| **数据延迟** | <5秒 | 从设备到前端显示 |
| **系统可用性** | 99.9% | 年度停机时间<8.76小时 |
| **并发处理** | 1000设备 | 同时在线设备数 |
| **数据吞吐** | 10000条/分钟 | 数据处理能力 |
| **响应时间** | <200ms | API接口响应时间 |
| **存储容量** | 无限制 | 基于Supabase云存储 |

---

## 4. 部署指南

### 4.1 环境准备

#### 4.1.1 服务器环境检查
```bash
# 检查操作系统版本
lsb_release -a

# 检查系统资源
free -h          # 内存
df -h            # 磁盘空间
nproc            # CPU核心数
```

#### 4.1.2 安装基础软件
```bash
# 更新系统
sudo apt update && sudo apt upgrade -y

# 安装Node.js 18
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt-get install -y nodejs

# 安装nginx
sudo apt install nginx -y

# 验证安装
node -v    # 应显示 v18.x.x
nginx -v   # 应显示版本信息
```

### 4.2 项目部署

#### 4.2.1 获取项目代码
```bash
# 克隆项目（或上传项目文件）
git clone <repository-url>
cd Landslide_monitor

# 检查项目结构
tree -L 3
```

#### 4.2.2 配置IoT服务
```bash
# 进入IoT服务目录
cd backend/iot-service

# 安装依赖
npm install

# 配置Supabase连接
nano iot-server.js
# 修改以下配置：
# const SUPABASE_URL = 'https://your-project.supabase.co';
# const SUPABASE_ANON_KEY = 'your-anon-key';
```

#### 4.2.3 配置nginx
```bash
# 编辑nginx配置
sudo nano /etc/nginx/sites-available/landslide-monitor

# 添加以下配置：
server {
    listen 1020;
    server_name your-domain.com;
    
    client_max_body_size 150M;
    
    location /iot/ {
        proxy_pass http://127.0.0.1:5100;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_cache_bypass $http_upgrade;
    }
}

# 启用配置
sudo ln -s /etc/nginx/sites-available/landslide-monitor /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

### 4.3 服务启动

#### 4.3.1 启动IoT服务
```bash
cd backend/iot-service
./start.sh
```

#### 4.3.2 验证部署
```bash
# 健康检查
curl http://localhost:5100/health

# 外部访问测试
curl http://your-domain.com:1020/iot/huawei \
  -X POST \
  -H "Content-Type: application/json" \
  -d '{"test": "deployment"}'
```

### 4.4 生产环境配置

#### 4.4.1 进程管理
```bash
# 安装PM2
npm install -g pm2

# 使用PM2启动服务
pm2 start iot-server.js --name landslide-iot

# 设置开机自启
pm2 startup
pm2 save
```

#### 4.4.2 防火墙配置
```bash
# 配置UFW防火墙
sudo ufw enable
sudo ufw allow ssh
sudo ufw allow 1020
sudo ufw allow 5100  # 仅本地访问
```

---

## 5. 配置管理

### 5.1 Supabase数据库配置

#### 5.1.1 创建项目
1. 访问 [supabase.com](https://supabase.com)
2. 创建新项目
3. 记录项目URL和API密钥

#### 5.1.2 创建数据表
```sql
-- 创建华为IoT数据表
CREATE TABLE huawei_iot_data (
  id BIGSERIAL PRIMARY KEY,
  device_id TEXT NOT NULL,
  product_id TEXT,
  service_id TEXT,
  event_time TIMESTAMPTZ,
  resource TEXT,
  event_type TEXT,
  
  -- 传感器数据字段
  temperature NUMERIC,
  humidity NUMERIC,
  acceleration_x NUMERIC,
  acceleration_y NUMERIC,
  acceleration_z NUMERIC,
  gyroscope_x NUMERIC,
  gyroscope_y NUMERIC,
  gyroscope_z NUMERIC,
  rainfall NUMERIC,
  pressure NUMERIC,
  altitude NUMERIC,
  battery_level NUMERIC,
  signal_strength NUMERIC,
  
  -- 原始数据
  raw_data JSONB,
  
  -- 时间戳
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- 创建索引
CREATE INDEX idx_huawei_iot_device_id ON huawei_iot_data(device_id);
CREATE INDEX idx_huawei_iot_event_time ON huawei_iot_data(event_time);
CREATE INDEX idx_huawei_iot_service_id ON huawei_iot_data(service_id);
CREATE INDEX idx_huawei_iot_created_at ON huawei_iot_data(created_at);

-- 配置权限
ALTER TABLE huawei_iot_data ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Allow anonymous insert" ON huawei_iot_data
FOR INSERT TO anon WITH CHECK (true);
CREATE POLICY "Allow authenticated select" ON huawei_iot_data
FOR SELECT TO authenticated USING (true);
```

### 5.2 华为云IoT平台配置

#### 5.2.1 产品创建
| 配置项 | 设置值 | 说明 |
|--------|--------|------|
| **产品名称** | landslide-monitor | 产品标识 |
| **协议类型** | MQTT | 通信协议 |
| **数据格式** | JSON | 数据格式 |
| **设备类型** | 直连设备 | 设备连接方式 |

#### 5.2.2 数据转发规则
| 配置项 | 设置值 | 说明 |
|--------|--------|------|
| **触发条件** | 设备属性上报 | 触发类型 |
| **动作类型** | HTTP推送 | 转发方式 |
| **目标URL** | http://your-domain.com:1020/iot/huawei | 接收地址 |
| **请求方法** | POST | HTTP方法 |
| **请求头** | Content-Type: application/json | 内容类型 |

### 5.3 环境变量配置

创建 `.env` 文件：
```bash
# 基础配置
NODE_ENV=production
PORT=5100

# Supabase配置
SUPABASE_URL=https://your-project.supabase.co
SUPABASE_ANON_KEY=your-anon-key

# 可选配置
LOG_LEVEL=info
REQUEST_TIMEOUT=30000
MAX_BODY_SIZE=10mb
IOT_DATA_TABLE=huawei_iot_data
```

---

## 6. API文档

### 6.1 接口概览

| 接口 | 方法 | 路径 | 功能 | 状态 |
|------|------|------|------|------|
| 健康检查 | GET | `/health` | 服务状态检查 | 已实现 |
| 服务信息 | GET | `/info` | 获取服务信息 | 已实现 |
| IoT数据接收 | POST | `/iot/huawei` | 接收华为IoT数据 | 已实现 |

### 6.2 接口详情

#### 6.2.1 健康检查接口

**基本信息**
- **接口地址**: `GET /health`
- **功能描述**: 检查服务运行状态
- **访问权限**: 公开访问

**请求示例**
```bash
curl http://localhost:5100/health
```

**响应示例**
```json
{
  "status": "OK",
  "timestamp": "2025-07-17T09:00:00.000Z",
  "service": "landslide-iot-service",
  "port": 5100
}
```

**响应字段说明**
| 字段 | 类型 | 说明 |
|------|------|------|
| status | String | 服务状态，OK表示正常 |
| timestamp | String | 响应时间戳 |
| service | String | 服务名称 |
| port | Number | 服务端口 |

#### 6.2.2 服务信息接口

**基本信息**
- **接口地址**: `GET /info`
- **功能描述**: 获取服务详细信息
- **访问权限**: 公开访问

**响应示例**
```json
{
  "name": "Landslide IoT Service",
  "version": "1.0.0",
  "description": "滑坡监测IoT数据接收服务",
  "endpoints": {
    "health": "GET /health",
    "info": "GET /info",
    "iot_data": "POST /iot/huawei"
  }
}
```

#### 6.2.3 IoT数据接收接口

**基本信息**
- **接口地址**: `POST /iot/huawei`
- **功能描述**: 接收华为云IoT平台推送的设备数据
- **访问权限**: 华为云IoT平台专用
- **Content-Type**: `application/json`

**请求数据格式**
```json
{
  "resource": "device.property",
  "event": "report",
  "event_time": "20240117T120000Z",
  "notify_data": {
    "header": {
      "device_id": "device-001",
      "product_id": "landslide-monitor",
      "app_id": "app-001"
    },
    "body": {
      "services": [{
        "service_id": "sensor_data",
        "properties": {
          "temperature": 25.5,
          "humidity": 60.2,
          "acceleration_x": 0.1,
          "acceleration_y": 0.2,
          "acceleration_z": 9.8,
          "gyroscope_x": 0.01,
          "gyroscope_y": 0.02,
          "gyroscope_z": 0.03,
          "rainfall": 0.0,
          "pressure": 1013.25,
          "battery_level": 85
        },
        "event_time": "20240117T120000Z"
      }]
    }
  }
}
```

**响应示例**
```json
{
  "Status Code": 200,
  "message": "数据接收成功",
  "timestamp": "2025-07-17T09:00:00.000Z",
  "device_id": "device-001",
  "processed_services": 1,
  "total_services": 1,
  "processing_time_ms": 150
}
```

**错误响应示例**
```json
{
  "Status Code": 400,
  "message": "数据格式错误",
  "error": "缺少notify_data字段",
  "timestamp": "2025-07-17T09:00:00.000Z"
}
```

### 6.3 数据字段说明

#### 6.3.1 传感器数据字段
| 字段名 | 数据类型 | 单位 | 说明 | 示例值 |
|--------|----------|------|------|--------|
| temperature | Number | ℃ | 环境温度 | 25.5 |
| humidity | Number | %RH | 相对湿度 | 60.2 |
| acceleration_x | Number | g | X轴加速度 | 0.1 |
| acceleration_y | Number | g | Y轴加速度 | 0.2 |
| acceleration_z | Number | g | Z轴加速度 | 9.8 |
| gyroscope_x | Number | °/s | X轴角速度 | 0.01 |
| gyroscope_y | Number | °/s | Y轴角速度 | 0.02 |
| gyroscope_z | Number | °/s | Z轴角速度 | 0.03 |
| rainfall | Number | mm | 降雨量 | 0.0 |
| pressure | Number | hPa | 大气压力 | 1013.25 |
| battery_level | Number | % | 电池电量 | 85 |

#### 6.3.2 系统字段
| 字段名 | 数据类型 | 说明 | 示例值 |
|--------|----------|------|--------|
| device_id | String | 设备唯一标识 | "device-001" |
| product_id | String | 产品标识 | "landslide-monitor" |
| service_id | String | 服务标识 | "sensor_data" |
| event_time | String | 事件时间 | "20240117T120000Z" |
| created_at | String | 创建时间 | "2025-07-17T09:00:00.000Z" |

---

## 7. 运维管理

### 7.1 服务管理

#### 7.1.1 基础命令
```bash
# 进入管理目录
cd /path/to/Landslide_monitor/backend

# 服务控制
npm run start:iot      # 启动IoT服务
npm run stop:iot       # 停止IoT服务
npm run restart:iot    # 重启IoT服务
npm run status         # 查看服务状态
npm run logs:iot       # 查看实时日志
```

#### 7.1.2 进程管理
```bash
# 查看进程
ps aux | grep iot-server

# 查看端口占用
sudo netstat -tlnp | grep :5100

# 查看系统资源
top -p $(pgrep -f iot-server)
htop
```

#### 7.1.3 PM2管理（生产环境推荐）
```bash
# 安装PM2
npm install -g pm2

# 启动服务
pm2 start iot-server.js --name landslide-iot

# 管理命令
pm2 status              # 查看状态
pm2 logs landslide-iot  # 查看日志
pm2 restart landslide-iot  # 重启
pm2 stop landslide-iot     # 停止
pm2 delete landslide-iot   # 删除

# 监控
pm2 monit              # 实时监控
pm2 show landslide-iot # 详细信息

# 开机自启
pm2 startup
pm2 save
```

### 7.2 监控和告警

#### 7.2.1 健康检查脚本
```bash
#!/bin/bash
# health_check.sh

SERVICE_URL="http://localhost:5100/health"
LOG_FILE="/var/log/landslide-monitor/health.log"

# 检查服务状态
response=$(curl -s -o /dev/null -w "%{http_code}" $SERVICE_URL)

if [ $response -eq 200 ]; then
    echo "$(date): Service is healthy" >> $LOG_FILE
    exit 0
else
    echo "$(date): Service is unhealthy (HTTP $response)" >> $LOG_FILE
    # 发送告警通知
    # send_alert "Landslide IoT Service is down"
    exit 1
fi
```

#### 7.2.2 定时监控
```bash
# 添加到crontab
crontab -e

# 每分钟检查一次服务状态
* * * * * /path/to/health_check.sh

# 每小时清理日志
0 * * * * find /path/to/logs -name "*.log" -mtime +7 -delete
```

#### 7.2.3 性能监控
```bash
# 监控脚本 monitor.sh
#!/bin/bash

# 获取进程信息
PID=$(pgrep -f iot-server)
if [ -z "$PID" ]; then
    echo "Service not running"
    exit 1
fi

# CPU和内存使用率
CPU=$(ps -p $PID -o %cpu --no-headers)
MEM=$(ps -p $PID -o %mem --no-headers)

# 磁盘使用率
DISK=$(df -h / | awk 'NR==2 {print $5}' | sed 's/%//')

# 网络连接数
CONNECTIONS=$(ss -tulpn | grep :5100 | wc -l)

echo "$(date): CPU=${CPU}% MEM=${MEM}% DISK=${DISK}% CONN=${CONNECTIONS}"
```

### 7.3 日志管理

#### 7.3.1 日志配置
```bash
# 创建日志目录
sudo mkdir -p /var/log/landslide-monitor
sudo chown $USER:$USER /var/log/landslide-monitor

# 配置logrotate
sudo nano /etc/logrotate.d/landslide-monitor

# 内容：
/var/log/landslide-monitor/*.log {
    daily
    rotate 30
    compress
    delaycompress
    missingok
    notifempty
    copytruncate
    create 644 $USER $USER
}
```

#### 7.3.2 日志分析
```bash
# 查看实时日志
tail -f backend/iot-service/server.log

# 分析错误日志
grep "ERROR" backend/iot-service/server.log

# 统计处理量
grep "数据接收成功" backend/iot-service/server.log | wc -l

# 分析响应时间
grep "processing_time_ms" backend/iot-service/server.log | \
  awk -F'"processing_time_ms":' '{print $2}' | \
  awk -F',' '{print $1}' | \
  sort -n
```

### 7.4 备份和恢复

#### 7.4.1 配置备份
```bash
#!/bin/bash
# backup.sh

BACKUP_DIR="/backup/landslide-monitor"
DATE=$(date +%Y%m%d_%H%M%S)

# 创建备份目录
mkdir -p $BACKUP_DIR/$DATE

# 备份配置文件
cp -r backend/iot-service/*.js $BACKUP_DIR/$DATE/
cp -r backend/iot-service/package.json $BACKUP_DIR/$DATE/
cp /etc/nginx/sites-available/landslide-monitor $BACKUP_DIR/$DATE/

# 压缩备份
tar -czf $BACKUP_DIR/config_$DATE.tar.gz -C $BACKUP_DIR $DATE
rm -rf $BACKUP_DIR/$DATE

echo "Backup completed: $BACKUP_DIR/config_$DATE.tar.gz"
```

#### 7.4.2 数据库备份
```bash
# Supabase数据备份（通过API）
curl -X GET "https://your-project.supabase.co/rest/v1/huawei_iot_data" \
  -H "apikey: your-anon-key" \
  -H "Authorization: Bearer your-anon-key" \
  > backup_$(date +%Y%m%d).json
```

---

## 8. 故障排除

### 8.1 常见问题诊断

#### 8.1.1 服务无法启动

**问题现象**
```
npm run start:iot 失败
或者 ./start.sh 报错
```

**诊断步骤**
```bash
# 1. 检查Node.js版本
node -v  # 需要18+

# 2. 检查端口占用
sudo netstat -tlnp | grep :5100

# 3. 检查依赖安装
cd backend/iot-service
npm list

# 4. 检查配置文件
grep -n "SUPABASE" iot-server.js
```

**解决方案**
```bash
# 杀死占用进程
sudo kill -9 <PID>

# 重新安装依赖
rm -rf node_modules package-lock.json
npm install

# 检查配置
nano iot-server.js
```

#### 8.1.2 外部访问失败

**问题现象**
```
curl http://domain:1020/iot/huawei 返回404或502
```

**诊断步骤**
```bash
# 1. 检查nginx配置
sudo nginx -t

# 2. 检查nginx状态
sudo systemctl status nginx

# 3. 检查本地服务
curl http://localhost:5100/health

# 4. 查看nginx日志
sudo tail -f /var/log/nginx/error.log
```

**解决方案**
```bash
# 重新加载nginx配置
sudo systemctl reload nginx

# 检查防火墙
sudo ufw status
sudo ufw allow 1020

# 重启nginx
sudo systemctl restart nginx
```

#### 8.1.3 数据库连接失败

**问题现象**
```
processed_services: 0
数据未插入数据库
```

**诊断步骤**
```bash
# 1. 检查Supabase配置
grep -A5 -B5 "SUPABASE" backend/iot-service/iot-server.js

# 2. 测试网络连接
curl -I https://your-project.supabase.co

# 3. 查看详细错误
tail -f backend/iot-service/server.log
```

**解决方案**
```bash
# 验证Supabase URL和KEY
# 检查Supabase项目状态
# 确认数据库表存在
# 检查RLS策略
```

### 8.2 性能问题

#### 8.2.1 响应时间过长

**诊断方法**
```bash
# 监控响应时间
curl -w "@curl-format.txt" -o /dev/null -s http://localhost:5100/health

# curl-format.txt内容：
#     time_namelookup:  %{time_namelookup}\n
#        time_connect:  %{time_connect}\n
#     time_appconnect:  %{time_appconnect}\n
#    time_pretransfer:  %{time_pretransfer}\n
#       time_redirect:  %{time_redirect}\n
#  time_starttransfer:  %{time_starttransfer}\n
#                     ----------\n
#          time_total:  %{time_total}\n
```

**优化方案**
- 增加服务器资源
- 优化数据库查询
- 启用缓存机制
- 使用负载均衡

#### 8.2.2 内存泄漏

**诊断方法**
```bash
# 监控内存使用
ps -p $(pgrep -f iot-server) -o pid,ppid,cmd,%mem,%cpu --sort=-%mem

# 使用Node.js内存分析
node --inspect iot-server.js
```

**解决方案**
- 定期重启服务
- 优化代码逻辑
- 增加内存限制
- 使用内存分析工具

### 8.3 数据问题

#### 8.3.1 数据丢失

**诊断步骤**
1. 检查华为云IoT推送日志
2. 查看服务接收日志
3. 验证数据库插入记录
4. 检查网络连接稳定性

**预防措施**
- 实现数据重试机制
- 添加数据校验
- 设置告警监控
- 定期数据备份

#### 8.3.2 数据格式错误

**常见错误**
```json
{
  "Status Code": 400,
  "message": "数据格式错误",
  "error": "缺少notify_data字段"
}
```

**解决方案**
- 验证华为云IoT配置
- 检查设备数据格式
- 更新数据解析逻辑
- 添加数据格式验证

---

## 9. 安全规范

### 9.1 网络安全

#### 9.1.1 防火墙配置
```bash
# 基础防火墙规则
sudo ufw enable
sudo ufw default deny incoming
sudo ufw default allow outgoing

# 允许必要端口
sudo ufw allow ssh
sudo ufw allow 1020/tcp    # nginx
sudo ufw limit ssh        # 限制SSH连接频率

# 限制特定IP访问
sudo ufw allow from 192.168.1.0/24 to any port 5100
```

#### 9.1.2 nginx安全配置
```nginx
# 隐藏nginx版本
server_tokens off;

# 限制请求大小
client_max_body_size 10M;

# 限制连接数
limit_conn_zone $binary_remote_addr zone=conn_limit_per_ip:10m;
limit_conn conn_limit_per_ip 10;

# 限制请求频率
limit_req_zone $binary_remote_addr zone=req_limit_per_ip:10m rate=10r/s;
limit_req zone=req_limit_per_ip burst=20 nodelay;

# 安全头
add_header X-Frame-Options DENY;
add_header X-Content-Type-Options nosniff;
add_header X-XSS-Protection "1; mode=block";
```

### 9.2 数据安全

#### 9.2.1 敏感信息保护
```bash
# 环境变量文件权限
chmod 600 .env

# 配置文件权限
chmod 644 iot-server.js
chown root:root iot-server.js

# 日志文件权限
chmod 640 server.log
```

#### 9.2.2 数据库安全
- 启用Supabase行级安全策略（RLS）
- 定期轮换API密钥
- 限制数据库访问权限
- 启用数据库审计日志

### 9.3 访问控制

#### 9.3.1 API访问控制
```javascript
// IP白名单验证
const allowedIPs = ['华为云IoT平台IP段'];

app.use('/iot/', (req, res, next) => {
  const clientIP = req.ip || req.connection.remoteAddress;
  if (!allowedIPs.includes(clientIP)) {
    return res.status(403).json({error: 'Access denied'});
  }
  next();
});
```

#### 9.3.2 请求验证
```javascript
// 请求签名验证（可选）
const crypto = require('crypto');

function verifySignature(req, secret) {
  const signature = req.headers['x-signature'];
  const payload = JSON.stringify(req.body);
  const expectedSignature = crypto
    .createHmac('sha256', secret)
    .update(payload)
    .digest('hex');

  return signature === expectedSignature;
}
```

---

## 10. 附录

### 10.1 错误代码表

| 错误代码 | HTTP状态码 | 错误信息 | 解决方案 |
|----------|------------|----------|----------|
| 400 | 400 | 数据格式错误 | 检查请求数据格式 |
| 401 | 401 | 未授权访问 | 检查API密钥 |
| 403 | 403 | 访问被拒绝 | 检查IP白名单 |
| 404 | 404 | 接口不存在 | 检查请求路径 |
| 500 | 500 | 服务器内部错误 | 查看服务日志 |
| 502 | 502 | 网关错误 | 检查nginx配置 |
| 503 | 503 | 服务不可用 | 检查服务状态 |

### 10.2 配置参数参考

#### 10.2.1 环境变量
| 变量名 | 默认值 | 说明 |
|--------|--------|------|
| NODE_ENV | development | 运行环境 |
| PORT | 5100 | 服务端口 |
| LOG_LEVEL | info | 日志级别 |
| REQUEST_TIMEOUT | 30000 | 请求超时(ms) |
| MAX_BODY_SIZE | 10mb | 最大请求体大小 |

#### 10.2.2 性能参数
| 参数 | 推荐值 | 说明 |
|------|--------|------|
| 最大并发连接 | 1000 | nginx worker_connections |
| 请求频率限制 | 10r/s | 每秒请求数限制 |
| 内存使用限制 | 512MB | Node.js进程内存限制 |
| 日志保留天数 | 30天 | 日志轮转配置 |

### 10.3 常用命令速查

#### 10.3.1 服务管理
```bash
# 启动服务
cd backend && npm run start:iot

# 停止服务
npm run stop:iot

# 查看状态
npm run status

# 查看日志
npm run logs:iot
```

#### 10.3.2 故障诊断
```bash
# 检查服务健康
curl http://localhost:5100/health

# 检查端口占用
sudo netstat -tlnp | grep :5100

# 查看进程信息
ps aux | grep iot-server

# 查看系统资源
top -p $(pgrep -f iot-server)
```

#### 10.3.3 日志分析
```bash
# 实时日志
tail -f backend/iot-service/server.log

# 错误日志
grep "ERROR" backend/iot-service/server.log

# 统计请求量
grep "数据接收成功" backend/iot-service/server.log | wc -l
```

### 10.4 联系信息

| 角色 | 联系方式 | 职责 |
|------|----------|------|
| **技术负责人** | tech@example.com | 技术架构和开发 |
| **运维负责人** | ops@example.com | 系统运维和监控 |
| **产品负责人** | product@example.com | 产品规划和需求 |
| **紧急联系** | emergency@example.com | 7x24小时紧急支持 |

### 10.5 相关资源

- **华为云IoT平台文档**: https://support.huaweicloud.com/iot/
- **Supabase官方文档**: https://supabase.com/docs
- **Node.js官方文档**: https://nodejs.org/docs/
- **nginx官方文档**: https://nginx.org/en/docs/
- **项目GitHub仓库**: https://github.com/your-org/landslide-monitor

---

**文档版本**: v1.0.0
**最后更新**: 2025年7月17日
**文档状态**: 正式发布
**适用版本**: 滑坡监测系统 v1.0+
