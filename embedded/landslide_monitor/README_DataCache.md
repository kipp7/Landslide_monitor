# 数据存储和断线重发系统使用说明

## 🎯 **功能概述**

本系统为OpenHarmony rk2206滑坡监测项目提供了完善的数据缓存、断线重发和冗余设计功能，确保在网络不稳定的环境下数据不丢失。

## 🏗️ **系统架构**

### **核心组件**
1. **数据缓存管理器** - 管理待发送数据的缓存队列
2. **连接状态监控器** - 实时监控WiFi和MQTT连接状态
3. **自动重发机制** - 网络恢复后自动发送缓存数据
4. **统计和诊断** - 提供详细的运行状态和统计信息

### **数据流程**
```
传感器数据 → 数据转换 → 连接检查 → [实时发送 | 缓存存储] → 网络恢复 → 缓存重发
```

## 📊 **配置参数**

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `MAX_CACHE_SIZE` | 100 | 最大缓存数据条数 |
| `MAX_RETRY_COUNT` | 3 | 单条数据最大重试次数 |
| `RETRY_INTERVAL_MS` | 5000 | 重试间隔时间(毫秒) |
| `CACHE_FILE_PATH` | "/data/iot_cache.dat" | 缓存文件路径 |

## 🚀 **使用方法**

### **1. 基本使用**
```c
#include "iot_cloud.h"

// 初始化IoT云服务（自动初始化缓存系统）
IoTCloud_Init();

// 发送数据（自动处理缓存和重发）
LandslideIotData sensor_data = {0};
// ... 填充传感器数据 ...
IoTCloud_SendData(&sensor_data);
```

### **2. 手动管理缓存**
```c
// 手动初始化缓存系统
DataCache_Init();

// 查看缓存统计
DataCache_PrintStats();

// 强制发送缓存数据
DataCache_SendPending();

// 清空缓存
DataCache_Clear();
```

### **3. 连接状态监控**
```c
// 更新连接状态
ConnectionStatus_Update();

// 检查连接是否稳定
if (ConnectionStatus_IsStable()) {
    printf("网络连接稳定\n");
}

// 打印连接统计
ConnectionStatus_PrintStats();
```

## 🧪 **测试功能**

### **缓存系统测试**
```c
// 测试缓存系统功能
IoTCloud_TestCacheSystem();
```

### **网络故障模拟**
```c
// 模拟10秒网络故障
IoTCloud_SimulateNetworkFailure(10);
```

### **强制重发缓存**
```c
// 强制重发所有缓存数据
IoTCloud_ForceResendCache();
```

## 📈 **监控和诊断**

### **缓存统计信息**
- 当前缓存数量
- 总缓存数量
- 发送成功数量
- 发送失败数量
- 成功率统计

### **连接状态信息**
- WiFi连接状态
- MQTT连接状态
- 断线次数统计
- 重连次数统计
- 网络错误次数
- 连接持续时长

## ⚙️ **工作原理**

### **数据缓存机制**
1. **实时发送优先**: 网络正常时直接发送数据
2. **自动缓存**: 网络异常时自动将数据加入缓存队列
3. **FIFO队列**: 使用先进先出队列管理缓存数据
4. **容量管理**: 缓存满时自动移除最旧数据

### **断线重发机制**
1. **连接监控**: 实时监控WiFi和MQTT连接状态
2. **自动重发**: 网络恢复后自动发送缓存数据
3. **重试限制**: 单条数据最多重试3次，避免无限重试
4. **批量处理**: 一次处理多条缓存数据，提高效率

### **冗余设计**
1. **多层检查**: WiFi和MQTT双重连接状态检查
2. **故障恢复**: 自动重连和数据恢复机制
3. **数据完整性**: 确保数据不丢失、不重复
4. **性能优化**: 避免阻塞主线程，保持系统响应

## 🔧 **高级配置**

### **修改缓存大小**
```c
// 在iot_cloud.h中修改
#define MAX_CACHE_SIZE 200  // 增加到200条
```

### **调整重试策略**
```c
// 在iot_cloud.h中修改
#define MAX_RETRY_COUNT 5      // 增加重试次数
#define RETRY_INTERVAL_MS 3000 // 减少重试间隔
```

### **自定义统计间隔**
```c
// 在IoTNetworkTask中修改
uint32_t cache_check_interval = 5000;   // 5秒检查缓存
uint32_t stats_print_interval = 30000;  // 30秒打印统计
```

## 📝 **日志输出示例**

```
✅ 数据缓存系统初始化成功
📦 数据已缓存 [1/100] 总缓存:1
⚠️  连接不稳定，数据加入缓存队列
📤 发送了 5 条缓存数据
📊 === 数据缓存统计 ===
当前缓存: 0/100 条
总缓存数: 15 条
发送成功: 15 条
发送失败: 0 条
成功率: 100.0%
========================
```

## ⚠️ **注意事项**

1. **内存使用**: 缓存系统会占用一定内存，请根据设备内存情况调整缓存大小
2. **文件系统**: rk2206平台文件系统支持有限，当前使用内存缓存
3. **网络稳定性**: 系统会自动处理网络波动，但长时间断网可能导致缓存溢出
4. **数据时效性**: 缓存数据可能存在时间延迟，适合对实时性要求不高的场景

## 🔍 **故障排除**

### **缓存不工作**
- 检查是否调用了`DataCache_Init()`
- 确认`g_cache_initialized`标志为true

### **数据发送失败**
- 检查WiFi和MQTT连接状态
- 查看网络错误统计信息
- 确认云平台配置正确

### **缓存溢出**
- 增加`MAX_CACHE_SIZE`值
- 检查网络连接稳定性
- 考虑增加发送频率

## 🏥 **系统健康监控**

### **健康检查功能**
```c
// 执行完整健康检查
IoTCloud_HealthCheck();

// 快速健康状态检查
if (IoTCloud_IsSystemHealthy()) {
    printf("系统健康\n");
}

// 打印系统状态总览
IoTCloud_PrintSystemStatus();
```

### **自动健康监控**
- **定期检查**: 每5分钟自动执行健康检查
- **异常告警**: 发现问题时自动输出详细诊断信息
- **状态报告**: 每60秒输出网络连接质量报告

### **健康指标**
- ✅ **缓存使用率** < 80%
- ✅ **网络连接稳定性**
- ✅ **数据发送成功率** > 90%
- ✅ **网络错误次数** < 10次

## 📈 **性能监控**

### **实时统计**
- 数据上传成功率实时计算
- 网络连接质量持续监控
- 缓存使用情况动态跟踪
- 错误统计和趋势分析

### **日志输出示例**
```
📊 === 定期状态报告 ===
🌐 === 网络连接质量 ===
WiFi状态: ✅ 已连接
MQTT状态: ✅ 已连接
连接稳定性: 🟢 稳定
========================

📈 数据上传成功率: 98.5% (197/200)

🏥 执行定期健康检查...
✅ 系统健康状态良好
```

## 📞 **技术支持**

如有问题，请查看系统日志输出，使用测试功能进行诊断，或联系技术支持团队。

### **快速诊断命令**
```c
IoTCloud_HealthCheck();        // 完整健康检查
IoTCloud_PrintSystemStatus();  // 系统状态总览
IoTCloud_TestCacheSystem();    // 缓存系统测试
```
