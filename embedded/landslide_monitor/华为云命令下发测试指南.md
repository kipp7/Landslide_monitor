# 华为云IoT平台命令下发测试指南

## 问题解决说明

### 1. MQTTYield错误255解释
```
wait_message: MQTTYield error 255 (not disconnecting)
```
**这是正常现象！** 错误255表示MQTT超时，即在指定时间内没有收到消息，这是正常的等待状态，不是错误。

### 2. 自测试命令移除
原来的自测试命令已被移除，因为：
- 华为云IoT平台不支持设备向自己发送命令
- 设备只能接收来自华为云平台的命令
- 自测试会导致混淆和不必要的错误

### 3. 当前系统状态
系统显示以下信息表示**连接正常**：
```
MQTT connected successfully to Huawei IoT Platform!
SUCCESS: MQTT subscription to command topic successful!
Device is now ready to receive commands from Huawei Cloud
*** WAITING FOR COMMANDS *** MQTT Connected: YES
```

## 正确的测试方法

### 1. 通过华为云IoT平台控制台测试

#### 步骤1：登录华为云IoT平台
1. 访问华为云IoT设备管理控制台
2. 找到设备ID：`6815a14f9314d118511807c6_rk2206`
3. 进入设备详情页面

#### 步骤2：发送命令
在设备控制台的"命令下发"页面，发送以下JSON命令：

**蜂鸣器测试命令：**
```json
{
  "service_id": "landslide_monitor",
  "command_name": "control_buzzer",
  "paras": {
    "enable": true,
    "frequency": 2000,
    "duration": 3,
    "pattern": 1
  }
}
```

**马达测试命令：**
```json
{
  "service_id": "landslide_monitor", 
  "command_name": "control_motor",
  "paras": {
    "enable": true,
    "speed": 50,
    "direction": 1,
    "duration": 5
  }
}
```

### 2. 通过华为云API测试

使用华为云IoT平台的REST API发送命令：

```bash
POST /v5/iot/{project_id}/devices/{device_id}/commands
Content-Type: application/json

{
  "service_id": "landslide_monitor",
  "command_name": "control_buzzer", 
  "paras": {
    "enable": true,
    "frequency": 3000,
    "pattern": 2
  }
}
```

### 3. 预期的设备响应

当命令发送成功时，设备串口会显示：

```
!!! CALLBACK TRIGGERED !!! Count: 1
Message arrived on topic $oc/devices/6815a14f9314d118511807c6_rk2206/sys/commands/request_id=xxx
=== BUZZER CONTROL COMMAND ===
Buzzer parameters: enable=true, frequency=3000Hz, duration=0s, pattern=2
*** STARTING BUZZER *** (Start command #1)
Handling buzzer command: ENABLE
Frequency: 3000Hz, Duration: 0s, Pattern: LONG_BEEP
Buzzer long beep pattern
Buzzer beep: 1000ms at 3000Hz
SUCCESS: Response published successfully to Huawei Cloud!
```

## 支持的命令列表

### 1. 蜂鸣器控制
```json
{
  "service_id": "landslide_monitor",
  "command_name": "control_buzzer",
  "paras": {
    "enable": true/false,
    "frequency": 100-10000,
    "duration": 0-3600,
    "pattern": 0-3
  }
}
```

### 2. 马达控制
```json
{
  "service_id": "landslide_monitor",
  "command_name": "control_motor", 
  "paras": {
    "enable": true/false,
    "speed": 0-100,
    "direction": 0-2,
    "duration": 0-3600
  }
}
```

### 3. RGB灯控制
```json
{
  "service_id": "landslide_monitor",
  "command_name": "control_rgb",
  "paras": {
    "enable": true/false,
    "red": 0-255,
    "green": 0-255,
    "blue": 0-255
  }
}
```

### 4. 报警重置
```json
{
  "service_id": "landslide_monitor",
  "command_name": "reset_alarm",
  "paras": {}
}
```

### 5. 系统重启
```json
{
  "service_id": "landslide_monitor",
  "command_name": "system_reboot",
  "paras": {}
}
```

## 故障排除

### 1. 如果命令没有响应
- 检查设备ID是否匹配
- 确认MQTT连接状态为"Connected: YES"
- 验证JSON格式是否正确
- 检查service_id和command_name是否正确

### 2. 如果看到MQTTYield错误255
- **这是正常的！** 255表示超时，不是错误
- 系统会继续等待命令，不会断开连接

### 3. 如果设备离线
- 检查WiFi连接状态
- 确认华为云IoT平台配置正确
- 重启设备重新连接

## 测试建议

1. **先测试简单命令**：从蜂鸣器开始测试
2. **观察串口输出**：确认命令被正确接收和处理
3. **验证设备响应**：检查华为云平台是否收到设备响应
4. **测试不同参数**：尝试不同的频率、持续时间等参数
5. **测试错误处理**：发送无效参数测试系统稳定性

## 重要提醒

- 设备已正确连接到华为云IoT平台
- MQTTYield错误255是正常的超时，不是故障
- 命令必须从华为云平台发送，不能设备自测试
- 所有命令都会自动响应给华为云平台
- 系统支持离线缓存和自动重连功能
