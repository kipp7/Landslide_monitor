# 马达停止命令调试指南

## 问题现状

用户反馈：停止命令仍然解析不到，无法正常停止马达。

## 🔍 **调试步骤**

### **步骤1：检查命令格式**

确保您发送的停止命令格式正确：

#### **✅ 正确的停止命令格式**
```json
{
  "service_id": "smartHome",
  "command_name": "control_motor",
  "paras": {
    "enable": false
  }
}
```

#### **❌ 错误的格式示例**
```json
// 错误1：缺少paras包装
{
  "service_id": "smartHome", 
  "command_name": "control_motor",
  "enable": false  // ❌ 应该在paras对象内
}

// 错误2：参数名错误
{
  "service_id": "smartHome",
  "command_name": "control_motor", 
  "paras": {
    "enabled": false  // ❌ 应该是"enable"
  }
}

// 错误3：数据类型错误
{
  "service_id": "smartHome",
  "command_name": "control_motor",
  "paras": {
    "enable": "false"  // ❌ 应该是布尔值false，不是字符串"false"
  }
}
```

### **步骤2：查看串口调试输出**

发送停止命令后，查看串口输出，应该看到以下调试信息：

#### **✅ 正常的调试输出**
```
=== MOTOR CONTROL COMMAND ===
Full JSON received: {"command_name":"control_motor","paras":{"enable":false}}
Paras content: {"enable":false}
Parameter check:
  enable: exists (type: 1)
  speed: NULL (type: -1)
  direction: NULL (type: -1)
  duration: NULL (type: -1)
Enable parameter is boolean, value: false
*** STOPPING MOTOR *** (Stop command #1)
Raw parameters: enable=false (stop command)
Calling Motor_Off() directly...
Motor_Off() called successfully
Motor stopped directly
Double-checking motor stop...
Motor stop confirmed
```

#### **❌ 异常的调试输出**

**情况1：JSON解析失败**
```
=== MOTOR CONTROL COMMAND ===
ERROR: 'paras' object not found in JSON
```
**解决方案**：检查JSON格式，确保有`paras`对象

**情况2：enable参数类型错误**
```
=== MOTOR CONTROL COMMAND ===
Full JSON received: {"command_name":"control_motor","paras":{"enable":"false"}}
Paras content: {"enable":"false"}
Parameter check:
  enable: exists (type: 4)  // type 4 = 字符串，应该是 type 1 = 布尔值
ERROR: enable parameter is not boolean or missing
Enable parameter type: 4 (expected: 1 for boolean)
```
**解决方案**：确保enable值是布尔类型`false`，不是字符串`"false"`

**情况3：enable参数缺失**
```
=== MOTOR CONTROL COMMAND ===
Full JSON received: {"command_name":"control_motor","paras":{}}
Paras content: {}
Parameter check:
  enable: NULL (type: -1)
ERROR: enable parameter is not boolean or missing
Enable parameter is NULL
```
**解决方案**：确保JSON中包含`enable`参数

### **步骤3：检查华为云IoT平台配置**

#### **设备产品模型检查**
1. 登录华为云IoT设备接入控制台
2. 进入产品 → 模型定义 → 命令
3. 确认`control_motor`命令存在且配置正确

#### **命令参数配置**
```
命令标识符: control_motor
命令名称: 控制马达
参数列表:
  - enable (boolean): 是否启用
  - speed (int): 速度 (可选)
  - direction (int): 方向 (可选) 
  - duration (int): 持续时间 (可选)
```

### **步骤4：测试不同的命令格式**

#### **测试1：最简停止命令**
```json
{
  "service_id": "smartHome",
  "command_name": "control_motor",
  "paras": {
    "enable": false
  }
}
```

#### **测试2：带额外参数的停止命令**
```json
{
  "service_id": "smartHome", 
  "command_name": "control_motor",
  "paras": {
    "enable": false,
    "speed": 0,
    "direction": 0,
    "duration": 0
  }
}
```

#### **测试3：先启动再停止**
```json
// 1. 启动命令
{
  "service_id": "smartHome",
  "command_name": "control_motor", 
  "paras": {
    "enable": true,
    "speed": 50
  }
}

// 2. 停止命令
{
  "service_id": "smartHome",
  "command_name": "control_motor",
  "paras": {
    "enable": false
  }
}
```

## 🛠️ **故障排除**

### **问题1：命令根本没有到达设备**
**症状**：串口没有任何`=== MOTOR CONTROL COMMAND ===`输出
**可能原因**：
- 网络连接问题
- MQTT连接断开
- 设备ID不匹配
- 华为云平台配置错误

**解决方案**：
1. 检查WiFi连接状态
2. 检查MQTT连接状态
3. 验证设备ID和密钥
4. 检查华为云平台设备状态

### **问题2：JSON解析失败**
**症状**：看到`ERROR: 'paras' object not found in JSON`
**可能原因**：
- JSON格式错误
- 缺少paras对象
- JSON编码问题

**解决方案**：
1. 使用JSON验证工具检查格式
2. 确保包含paras对象
3. 检查字符编码

### **问题3：参数类型错误**
**症状**：看到`ERROR: enable parameter is not boolean`
**可能原因**：
- enable值是字符串而不是布尔值
- JSON解析器配置问题

**解决方案**：
1. 确保enable值是`false`而不是`"false"`
2. 检查JSON生成代码

### **问题4：马达硬件不响应**
**症状**：看到停止日志但马达仍在运行
**可能原因**：
- 硬件连接问题
- 马达驱动问题
- 电源问题

**解决方案**：
1. 检查马达硬件连接
2. 测试马达驱动电路
3. 检查电源供应

## 📞 **获取帮助**

如果以上步骤都无法解决问题，请提供以下信息：

1. **完整的串口输出日志**
2. **发送的JSON命令内容**
3. **华为云IoT平台的命令发送日志**
4. **设备网络连接状态**
5. **马达硬件连接情况**

这样可以更准确地定位问题所在。

## 🎯 **快速测试命令**

复制以下命令直接在华为云IoT平台测试：

```json
{
  "service_id": "smartHome",
  "command_name": "control_motor",
  "paras": {
    "enable": false
  }
}
```

如果这个命令仍然无效，问题可能在于：
1. 华为云平台配置
2. 网络连接
3. 设备认证
4. JSON格式处理

请按照调试步骤逐一排查！
